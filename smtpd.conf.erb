<%= requires_version '0.0.1' %>
# Automatically generated by https://github.com/mneumann/mailconfgen

pki pki_<%= confval! 'server.name' %> cert "<%= confval! 'server.pki.cert' %>"
pki pki_<%= confval! 'server.name' %> key "<%= confval! 'server.pki.key' %>"

filter check_dyndns phase connect match rdns regex \
   { '.*\.dyn\..*', '.*\.dsl\..*' } \
   disconnect "550 no residential connections

filter check_rdns phase connect match !rdns \
   disconnect "550 no rDNS is so 80s"

filter check_fcrdns phase connect match !fcrdns \
   disconnect "550 no FCrDNS is so 80s"

filter senderscore \
   proc-exec "opensmtpd-filter-senderscore -blockBelow 10 -junkBelow 70 -slowFactor 5000"

filter dkimsign \
   proc-exec "opensmtpd-filter-dkimsign <%= opensmtpd_filter_dkimsign_params %>" \
   user _dkimsign group _dkimsign

table allowed-recipients file:<%= file("allowed-recipients").absolute_path %>
table virtual-users file:<%= file("virtual-users").absolute_path %>
table virtual-user-base file:<%= file("virtual-user-base").absolute_path %>
table passwd file:<%= file("passwd").absolute_path %>

# Public
listen on <%= confval! 'server.iface' %> \
   port smtp \
   tls \
   pki pki_<%= confval! 'server.name' %> \
   hostname "<%= confval! 'server.name' %>" \
   filter { check_dyndns, check_rdns, check_fcrdns, senderscore }

# Auth submission
listen on <%= confval! 'server.iface' %> \
   port submission \
   tls-require \
   pki pki_<%= confval! 'server.name' %> \
   hostname "<%= confval! 'server.name' %>" \
   auth <passwd> \
   filter dkimsign

action "local" \
   lmtp "/var/run/dovecot/lmtp" \
   virtual <virtual-users> \
   userbase <virtual-user-base>

action "outbound" \
   relay \
   helo <%= confval! 'server.name' %>

match \
   from any \
   for rcpt-to <allowed-recipients> \
   action "local"

match \
   from any \
     auth \
   for any \
   action "outbound"

